<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ’š DSA LAB SYSTEM â€“ Ù†Ø³Ø®Ø© ÙˆØ¯Ø§Ø¯ Ø§Ù„Ø±Ø³Ù…ÙŠØ©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase compat SDKs (Ø£Ø³Ù‡Ù„ Ø´ÙŠØ¡ Ù…Ø¹ GitHub Pages) -->
  <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore-compat.js"></script>

  <!-- QRCode Ù…ÙƒØªØ¨Ø© ØµØºÙŠØ±Ø© Ù„ØªÙˆÙ„ÙŠØ¯ QR Ù†ØµÙŠ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root {
      --green-main: #0b8a4a;
      --green-soft: #e9f7ef;
      --green-mid: #1f9e5a;
      --accent-yellow: #ffd95e;
      --danger: #d9534f;
      --text-dark: #133020;
      --card-radius: 18px;
      --shadow-soft: 0 10px 25px rgba(0,0,0,0.08);
      --font-ar: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: var(--font-ar);
      background: linear-gradient(135deg, #e6f9f0, #f6fffb);
      color: var(--text-dark);
    }

    .app-shell {
      display: flex;
      min-height: 100vh;
    }

    /* ====== Sidebar ===== */
    .sidebar {
      width: 230px;
      background: var(--green-main);
      color: #fff;
      display: flex;
      flex-direction: column;
      padding: 16px 10px;
    }

    .sidebar-header {
      text-align: center;
      margin-bottom: 16px;
      font-weight: 700;
      font-size: 15px;
      line-height: 1.6;
    }

    .sidebar-header span {
      display: block;
      font-size: 11px;
      opacity: .9;
    }

    .nav-list {
      list-style: none;
      padding: 0;
      margin: 0;
      flex: 1;
    }

    .nav-item {
      margin-bottom: 6px;
    }

    .nav-link {
      width: 100%;
      border: none;
      background: transparent;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 13px;
      cursor: pointer;
      transition: background .2s, transform .1s;
    }

    .nav-link span.en {
      font-size: 10px;
      opacity: .8;
    }

    .nav-link .icon {
      font-size: 16px;
      margin-left: 6px;
    }

    .nav-link.active {
      background: #fff;
      color: var(--green-main);
      transform: translateX(-3px);
    }

    .nav-link:hover {
      background: rgba(255,255,255,0.12);
    }

    .sidebar-footer {
      font-size: 10px;
      text-align: center;
      opacity: .8;
      margin-top: 8px;
    }

    /* ===== Main area ===== */
    .main {
      flex: 1;
      padding: 18px 20px;
      overflow-y: auto;
    }

    .page-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .page-subtitle {
      font-size: 11px;
      color: #555;
      margin-bottom: 14px;
    }

    .pages {
      display: none;
    }
    .pages.active {
      display: block;
    }

    /* ===== Cards & layout ===== */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 18px;
    }

    .card {
      background: #fff;
      border-radius: var(--card-radius);
      padding: 16px 18px;
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
    }

    .card h2 {
      margin: 0 0 4px;
      font-size: 16px;
    }

    .card h3 {
      margin: 0 0 10px;
      font-size: 13px;
      color: #444;
    }

    .card .en-label {
      display: block;
      font-size: 10px;
      color: #777;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--green-soft);
      font-size: 10px;
      margin-bottom: 8px;
    }

    .pill .dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--green-main);
      margin-left: 6px;
    }

    label {
      display: block;
      font-size: 12px;
      margin-bottom: 3px;
    }

    .label-en {
      font-size: 9px;
      color: #777;
      display: inline-block;
      margin-left: 4px;
    }

    input[type="text"],
    input[type="number"],
    input[type="datetime-local"],
    input[type="date"],
    input[type="password"],
    select,
    textarea {
      width: 100%;
      border-radius: 999px;
      border: 1px solid #ccc;
      padding: 8px 12px;
      font-size: 12px;
      outline: none;
      transition: border .15s, box-shadow .15s;
    }

    textarea {
      border-radius: 12px;
      min-height: 60px;
      resize: vertical;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--green-mid);
      box-shadow: 0 0 0 2px rgba(31,158,90,0.16);
    }

    .row {
      display: flex;
      gap: 10px;
    }

    .row > div {
      flex: 1;
    }

    .btn {
      border-radius: 999px;
      padding: 8px 16px;
      border: none;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 8px;
    }

    .btn-main {
      background: var(--green-mid);
      color: #fff;
    }

    .btn-main:hover { background: #147545; }

    .btn-ghost {
      background: #fff;
      border: 1px solid #ccc;
    }

    .btn-danger {
      background: var(--danger);
      color: #fff;
    }

    .badge {
      display: inline-block;
      background: #f2f2f2;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
      margin-left: 4px;
    }

    .status-chip {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
      background: #eef5ff;
      color: #234;
      margin-top: 4px;
    }

    .status-chip.complete {
      background: #e4ffe9;
      color: #176235;
    }

    .status-chip.in-lab {
      background: #fff6e1;
      color: #8a5a00;
    }

    .case-list {
      max-height: 340px;
      overflow-y: auto;
      margin-top: 6px;
      border-radius: 14px;
      border: 1px solid #eee;
    }

    .case-item {
      padding: 8px 10px;
      border-bottom: 1px solid #f1f1f1;
      font-size: 11px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .case-item:nth-child(odd) {
      background: #fcfffd;
    }

    .case-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .case-item-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
    }

    .muted {
      font-size: 10px;
      color: #777;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: #222;
      color: #fff;
      padding: 10px 16px;
      border-radius: 999px;
      font-size: 12px;
      opacity: 0;
      pointer-events: none;
      transition: opacity .2s, transform .2s;
      z-index: 9999;
    }

    .toast.show {
      opacity: 1;
      transform: translate(-50%, -8px);
      pointer-events: auto;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .app-shell {
        flex-direction: column-reverse;
      }
      .sidebar {
        width: 100%;
        flex-direction: row;
        overflow-x: auto;
        padding: 8px;
      }
      .sidebar-header {
        display: none;
      }
      .nav-link {
        font-size: 11px;
        white-space: nowrap;
      }
      .main {
        padding: 10px;
      }
    }
  </style>
</head>
<body>
<div class="app-shell">
  <!-- ========== SIDEBAR ========== -->
  <aside class="sidebar">
    <div class="sidebar-header">
      ğŸ’š DSA LAB SYSTEM<br/>
      <span>Ù†Ø³Ø®Ø© ÙˆØ¯Ø§Ø¯ Ø§Ù„Ø±Ø³Ù…ÙŠØ© â€“ V1</span>
    </div>
    <ul class="nav-list">
      <li class="nav-item">
        <button class="nav-link active" data-target="clinic-page">
          <div>
            ğŸ“‹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©<br/>
            <span class="en">Clinic Entry</span>
          </div>
          <span class="icon">â€¢</span>
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-target="lab-check-page">
          <div>
            ğŸ§ª Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù…Ø¹Ù…Ù„<br/>
            <span class="en">Lab Check-In</span>
          </div>
          <span class="icon">â€¢</span>
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-target="tech-page">
          <div>
            ğŸ‘¨ğŸ»â€ğŸ”§ Ù„ÙˆØ­Ø© Ø§Ù„ÙÙ†ÙŠÙŠÙ†<br/>
            <span class="en">Technicians Dashboard</span>
          </div>
          <span class="icon">â€¢</span>
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-target="ready-page">
          <div>
            âœ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ<br/>
            <span class="en">Ready for Clinic</span>
          </div>
          <span class="icon">â€¢</span>
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-target="search-page">
          <div>
            ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ø­Ø§Ù„Ø©<br/>
            <span class="en">Search Case</span>
          </div>
          <span class="icon">â€¢</span>
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-target="settings-page">
          <div>
            âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª<br/>
            <span class="en">Settings</span>
          </div>
          <span class="icon">â€¢</span>
        </button>
      </li>
    </ul>
    <div class="sidebar-footer">
      Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„ØµØ§Ø­Ø¨Ø© Ø§Ù„ÙÙƒØ±Ø© ğŸ’š ÙˆØ¯Ø§Ø¯ Ø§Ù„Ø¬Ø§Ø¨Ø±ÙŠ
    </div>
  </aside>

  <!-- ========== MAIN ========== -->
  <main class="main">

    <!-- ===== CLINIC ENTRY ===== -->
    <section id="clinic-page" class="pages active">
      <div class="page-title">ğŸ“‹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</div>
      <div class="page-subtitle">
        Ø£ÙˆÙ„ Ø®Ø·ÙˆØ© ØªØ¨Ø¯Ø£ Ù…Ù† Ù‡Ù†Ø§ â€“ ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø±Ù‚Ù… Ù…Ø¹Ù…Ù„ ÙˆØ¨Ø§Ø±ÙƒÙˆØ¯ ÙˆØªØªØ³Ø¬Ù„ ÙÙŠ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.
      </div>

      <div class="grid">
        <div class="card">
          <div class="pill"><span class="dot"></span> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ / Patient Info</div>
          <h2>Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©</h2>
          <form id="clinicForm">
            <div class="row">
              <div>
                <label>Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù <span class="label-en">File Number</span></label>
                <input type="text" id="fileNumber" required />
              </div>
              <div>
                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶ <span class="label-en">Patient Name</span></label>
                <input type="text" id="patientName" required />
              </div>
            </div>

            <div class="row">
              <div>
                <label>Ø±Ù‚Ù… Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© <span class="label-en">Clinic Number</span></label>
                <input type="text" id="clinicNumber" required />
              </div>
              <div>
                <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨ <span class="label-en">Doctor Name</span></label>
                <input type="text" id="doctorName" required />
              </div>
            </div>

            <div class="row">
              <div>
                <label>Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„Ø© <span class="label-en">Case Type</span></label>
                <select id="caseType" required>
                  <option value="">Ø§Ø®ØªÙŠØ§Ø±â€¦</option>
                  <option value="CAD/CAM Crown">Crown â€“ CAD/CAM</option>
                  <option value="PFM">PFM</option>
                  <option value="RPD">RPD (Removable)</option>
                  <option value="Ortho">Ortho</option>
                  <option value="Temporary">Temporary / Provisional</option>
                  <option value="Casting">Casting</option>
                  <option value="Other">Ø£Ø®Ø±Ù‰ / Other</option>
                </select>
              </div>
              <div>
                <label>Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù…Ø±ÙŠØ¶ Ø§Ù„Ù‚Ø§Ø¯Ù… <span class="label-en">Next Appointment</span></label>
                <input type="date" id="nextAppointment" />
              </div>
            </div>

            <div>
              <label>Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) <span class="label-en">Doctor Notes</span></label>
              <textarea id="doctorNote" placeholder="Ù…Ø«Ø§Ù„: Upper crown, shade A2â€¦"></textarea>
            </div>

            <div>
              <label>Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ø·Ù„Ø¨ / R4 / Snap (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <input type="text" id="requestImage" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ø£Ùˆ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©" />
            </div>

            <button type="submit" class="btn btn-main">
              ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© + ØªÙˆÙ„ÙŠØ¯ Ø±Ù‚Ù… Ù…Ø¹Ù…Ù„
            </button>
          </form>
        </div>

        <div class="card">
          <div class="pill"><span class="dot"></span> Ù…Ø¹Ø§ÙŠÙ†Ø© Ø³Ø±ÙŠØ¹Ø©</div>
          <h2>Ø¢Ø®Ø± Ø­Ø§Ù„Ø© ØªÙ… Ø­ÙØ¸Ù‡Ø§</h2>
          <div id="lastCaseBox" class="muted">
            Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø£ÙŠ Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯.
          </div>

          <hr style="margin: 14px 0; border: 0; border-top: 1px dashed #ddd;" />

          <h3>Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„Ø©</h3>
          <div id="barcodeText" class="badge">â€”</div>
          <div id="qrcode" style="margin-top: 10px;"></div>

          <p class="muted" style="margin-top: 10px;">
            ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„Ø¨Ø­Ø« ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙØ­Ø§Øª (Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ø¹Ù…Ù„ØŒ Ø§Ù„ÙÙ†ÙŠÙŠÙ†ØŒ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØŒ Ø§Ù„Ø¨Ø­Ø«).
          </p>
        </div>
      </div>
    </section>

    <!-- ===== LAB CHECK-IN ===== -->
    <section id="lab-check-page" class="pages">
      <div class="page-title">ğŸ§ª Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù…Ø¹Ù…Ù„ (Lab Check-In)</div>
      <div class="page-subtitle">
        Ø§Ù„Ø¹Ø§Ù…Ù„ Ø£Ùˆ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙŠÙ…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (Ø£Ùˆ ÙŠÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ù…Ù„/Ø§Ù„Ù…Ù„Ù) ÙˆÙŠØ¤ÙƒØ¯ ÙˆØµÙˆÙ„ Ø§Ù„Ø­Ø§Ù„Ø©.
      </div>

      <div class="grid">
        <div class="card">
          <div class="pill"><span class="dot"></span> Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø­Ø§Ù„Ø©</div>
          <h2>ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ / Ø§Ù„Ù…Ù„Ù</h2>
          <div class="row">
            <div>
              <label>Ø¨Ø­Ø« <span class="label-en">File / Lab / Barcode</span></label>
              <input type="text" id="labSearchInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ù…Ù„ Ø£Ùˆ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯" />
            </div>
            <div style="flex:0 0 auto; display:flex; align-items:flex-end;">
              <button class="btn btn-main" id="btnLabSearch">Ø¨Ø­Ø«</button>
            </div>
          </div>
          <div id="labSearchResult" style="margin-top:10px;" class="muted">
            Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø­Ø« Ø«Ù… Ø§Ø¶ØºØ· Ø¨Ø­Ø«.
          </div>
        </div>
      </div>
    </section>

    <!-- ===== TECH DASHBOARD ===== -->
    <section id="tech-page" class="pages">
      <div class="page-title">ğŸ‘¨ğŸ»â€ğŸ”§ Ù„ÙˆØ­Ø© Ø§Ù„ÙÙ†ÙŠÙŠÙ†</div>
      <div class="page-subtitle">
        ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„ÙÙ†ÙŠÙŠÙ†ØŒ ÙˆØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†ÙÙŠØ° (In Progress / Completed / Returned).
      </div>

      <div class="grid">
        <div class="card">
          <div class="pill"><span class="dot"></span> Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø³Ù… / Ø§Ù„ÙÙ†ÙŠ</div>
          <h2>Ø§Ù„ÙÙ„Ø§ØªØ±</h2>
          <div class="row">
            <div>
              <label>Ø§Ù„Ù‚Ø³Ù… <span class="label-en">Department</span></label>
              <select id="techDeptFilter">
                <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
                <option value="CAD/CAM">CAD/CAM</option>
                <option value="PFM">PFM</option>
                <option value="RPD">RPD</option>
                <option value="Ortho">Ortho</option>
                <option value="Temporary">Temporary</option>
                <option value="Casting">Casting</option>
              </select>
            </div>
            <div>
              <label>Ø§Ù„ÙÙ†ÙŠ <span class="label-en">Technician</span></label>
              <select id="techNameFilter">
                <option value="">ÙƒÙ„ Ø§Ù„ÙÙ†ÙŠÙŠÙ†</option>
              </select>
            </div>
          </div>
          <button class="btn btn-main" id="btnLoadTechCases" style="margin-top:10px;">
            ğŸ”„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª
          </button>
          <p class="muted" style="margin-top:6px;">
            ÙŠØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø­Ø§Ù„Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© ÙÙ‚Ø· Ù„ÙƒÙ„ ÙÙ†ÙŠØŒ Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ø¨Ø§Ø´Ø±Ø©.
          </p>
        </div>

        <div class="card">
          <div class="pill"><span class="dot"></span> Ø­Ø§Ù„Ø§Øª Ø§Ù„ÙÙ†ÙŠ</div>
          <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª</h2>
          <div id="techCasesList" class="case-list">
            <div class="case-item muted">
              Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ â€“ Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… ÙˆØ§Ù„ÙÙ†ÙŠ ÙˆØ§Ø¶ØºØ· ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª.
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ===== READY FOR CLINIC ===== -->
    <section id="ready-page" class="pages">
      <div class="page-title">âœ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ â€“ Ready for Clinic</div>
      <div class="page-subtitle">
        Ù‡Ù†Ø§ ØªØ±Ø§Ø¬Ø¹ÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© ÙˆØªØ³ÙˆÙŠÙ† Ready for Clinic Ù…Ø¹ Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Box.
      </div>

      <div class="grid">
        <div class="card">
          <div class="pill"><span class="dot"></span> Ø¨Ø­Ø« Ø¹Ù† Ø­Ø§Ù„Ø© Ù…ÙƒØªÙ…Ù„Ø©</div>
          <h2>ğŸ” Ø¨Ø­Ø«</h2>
          <div class="row">
            <div>
              <label>Ø¨Ø­Ø« <span class="label-en">File / Lab / Barcode</span></label>
              <input type="text" id="readySearchInput" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù Ø£Ùˆ Ø§Ù„Ù…Ø¹Ù…Ù„ Ø£Ùˆ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯" />
            </div>
            <div style="flex:0 0 auto; display:flex; align-items:flex-end;">
              <button class="btn btn-main" id="btnReadySearch">Ø¨Ø­Ø«</button>
            </div>
          </div>
          <div id="readySearchResult" style="margin-top:10px;" class="muted">
            Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø­Ø« Ø«Ù… Ø§Ø¶ØºØ· Ø¨Ø­Ø«.
          </div>
        </div>

        <div class="card">
          <div class="pill"><span class="dot"></span> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</div>
          <h2>Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„ØªØ³Ù„ÙŠÙ…</h2>
          <button class="btn btn-ghost" id="btnLoadCompleted" style="margin-bottom:6px;">
            ğŸ”„ Ø¹Ø±Ø¶ Ø¢Ø®Ø± Ù¢Ù  Ø­Ø§Ù„Ø© Completed
          </button>
          <div id="readyCasesList" class="case-list">
            <div class="case-item muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- ===== SEARCH PAGE ===== -->
    <section id="search-page" class="pages">
      <div class="page-title">ğŸ” Ø¨Ø­Ø« Ø´Ø§Ù…Ù„ Ø¹Ù† Ø­Ø§Ù„Ø©</div>
      <div class="page-subtitle">
        Ø¨Ø­Ø« ÙˆØ§Ø­Ø¯ ÙŠØ·Ù„Ø¹ Ù„Ùƒ ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© + ØªØ±ÙŠØ® Ø§Ù„ØªØªØ¨Ø¹ Tracking.
      </div>
      <div class="grid">
        <div class="card">
          <h2>Ø¨Ø­Ø«</h2>
          <label>Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù / Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ù…Ù„ / Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</label>
          <div class="row">
            <div>
              <input type="text" id="globalSearchInput" />
            </div>
            <div style="flex:0 0 auto; display:flex; align-items:flex-end;">
              <button class="btn btn-main" id="btnGlobalSearch">Ø¨Ø­Ø«</button>
            </div>
          </div>
          <p class="muted">ÙŠÙ…ÙƒÙ†Ùƒ Ù†Ø³Ø® Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† ÙˆØ±Ù‚Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø£Ùˆ Ù…Ù† ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø¨ÙŠØ¨.</p>
        </div>

        <div class="card">
          <div class="pill"><span class="dot"></span> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©</div>
          <h2>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
          <div id="globalCaseDetails" class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯.</div>
          <hr style="margin:10px 0; border:0; border-top:1px dashed #eee;">
          <h3>ØªØªØ¨Ø¹ Ø§Ù„Ø­Ø§Ù„Ø© (Tracking)</h3>
          <div id="globalTracking" class="muted">â€”</div>
        </div>
      </div>
    </section>

    <!-- ===== SETTINGS ===== -->
    <section id="settings-page" class="pages">
      <div class="page-title">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª â€“ Settings</div>
      <div class="page-subtitle">
        Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ù„Ù„Ø£Ø®ØµØ§Ø¦ÙŠØ© + Ø­Ø§Ù„Ø© Ø§Ù„ÙÙ†ÙŠÙŠÙ† (Ù†Ø´Ø· / Ø¥Ø¬Ø§Ø²Ø©) â€“ ÙŠØªÙ… Ø­ÙØ¸Ù‡Ø§ ÙÙŠ Firestore.
      </div>

      <div class="grid">
        <div class="card">
          <div class="pill"><span class="dot"></span> Ø§Ù„Ø£Ù…Ø§Ù†</div>
          <h2>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ù„Ù„Ø£Ø®ØµØ§Ø¦ÙŠØ©</h2>
          <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ <span class="label-en">Specialist PIN</span></label>
          <input type="password" id="specialistPinInput" placeholder="Ù…Ø«Ø§Ù„: 0987" />
          <button class="btn btn-main" id="btnSavePin">Ø­ÙØ¸ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ</button>
          <p class="muted">Ù‡Ø°Ø§ Ø§Ù„Ù€ PIN ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù„Ù‚ÙÙ„ Ø¨Ø¹Ø¶ Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ù‡Ù…Ø©.</p>
        </div>

        <div class="card">
          <div class="pill"><span class="dot"></span> Ø§Ù„ÙÙ†ÙŠÙŠÙ†</div>
          <h2>Ø­Ø§Ù„Ø© Ø§Ù„ÙÙ†ÙŠÙŠÙ†</h2>
          <p class="muted">
            ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„ÙÙ†ÙŠ (Ù†Ø´Ø· / Ø¥Ø¬Ø§Ø²Ø©) ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ÙÙ†ÙŠÙŠÙ†.
          </p>
          <button class="btn btn-ghost" id="btnSeedTechs">
            â• Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙ†ÙŠÙŠÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)
          </button>

          <label style="margin-top:8px;">Ø¨Ø­Ø« Ø¹Ù† ÙÙ†ÙŠ</label>
          <input type="text" id="techSearchInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù…â€¦" />

          <div id="techSettingsList" class="case-list" style="margin-top:8px;">
            <div class="case-item muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯.</div>
          </div>
        </div>
      </div>
    </section>

  </main>
</div>

<div id="toast" class="toast"></div>

<script>
  // ========= Firebase init =========
  const firebaseConfig = {
    apiKey: "AIzaSyARQRegsdUi6hO_p6txm1XjnAV45cAU4Ac",
    authDomain: "dsa-lab-system.firebaseapp.com",
    projectId: "dsa-lab-system",
    storageBucket: "dsa-lab-system.firebasestorage.app",
    messagingSenderId: "1081285804674",
    appId: "1:1081285804674:web:91e4775b7bfa5e60366a9b",
    measurementId: "G-271TRGHNVJ"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const casesRef = db.collection("cases");
  const countersRef = db.collection("counters").doc("labNumber");
  const settingsRef = db.collection("settings").doc("global");
  const techsRef = db.collection("technicians");

  // ========= UI helpers =========
  const navLinks = document.querySelectorAll(".nav-link");
  const pages = document.querySelectorAll(".pages");
  const toastEl = document.getElementById("toast");
  let qr;

  function showToast(msg) {
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    setTimeout(() => toastEl.classList.remove("show"), 2600);
  }

  function switchPage(id) {
    pages.forEach(p => p.classList.toggle("active", p.id === id));
    navLinks.forEach(b => b.classList.toggle("active", b.dataset.target === id));
  }

  navLinks.forEach(btn => {
    btn.addEventListener("click", () => switchPage(btn.dataset.target));
  });

  // ========= QR preview =========
  function updateQR(barcode) {
    const barcodeText = document.getElementById("barcodeText");
    if (!barcode) {
      barcodeText.textContent = "â€”";
      if (qr) qr.clear();
      return;
    }
    barcodeText.textContent = barcode;
    if (!qr) {
      qr = new QRCode(document.getElementById("qrcode"), {
        text: barcode,
        width: 120,
        height: 120
      });
    } else {
      qr.clear();
      qr.makeCode(barcode);
    }
  }

  // ========= LAB NUMBER GENERATOR =========
  async function getNextLabNumber() {
    const newNumber = await db.runTransaction(async (tx) => {
      const snap = await tx.get(countersRef);
      let current = 0;
      if (snap.exists && typeof snap.data().current === "number") {
        current = snap.data().current;
      }
      const updated = current + 1;
      tx.set(countersRef, { current: updated }, { merge: true });
      return updated;
    });
    return "LAB-" + String(newNumber).padStart(6, "0");
  }

  // ========= CASE HELPERS =========
  function inferDepartment(caseType) {
    if (!caseType) return "";
    const t = caseType.toLowerCase();
    if (t.includes("cad") || t.includes("crown")) return "CAD/CAM";
    if (t.includes("pfm")) return "PFM";
    if (t.includes("rpd")) return "RPD";
    if (t.includes("ortho")) return "Ortho";
    if (t.includes("temp")) return "Temporary";
    if (t.includes("cast")) return "Casting";
    return "Other";
  }

  function renderCaseSummary(container, docId, data) {
    const html = `
      <div>
        <strong>${data.patientName || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"}</strong>
        <span class="badge">Ù…Ù„Ù: ${data.fileNumber || "-"}</span>
        <span class="badge">Lab: ${data.labNumber || "-"}</span>
      </div>
      <div class="muted" style="margin-top:4px;">
        Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„Ø©: ${data.caseType || "-"} â€“ Ø¯.${data.doctorName || "-"} â€“ Ø¹ÙŠØ§Ø¯Ø© ${data.clinicNumber || "-"}
      </div>
      <div class="status-chip ${data.status === "Ready for Clinic" ? "complete" : ""}">
        Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${data.status || "-"}
      </div>
      <div class="muted" style="margin-top:4px;">ID: ${docId}</div>
    `;
    container.innerHTML = html;
  }

  async function addTracking(docId, status, updatedBy, note) {
    const trackingRef = casesRef.doc(docId).collection("tracking");
    await trackingRef.add({
      status,
      updatedBy,
      note: note || "",
      time: firebase.firestore.Timestamp.now()
    });
  }

  async function findCaseByAnyKey(key) {
    if (!key) return null;
    const trimmed = key.trim();
    // 1) fileNumber
    let snap = await casesRef.where("fileNumber", "==", trimmed).limit(1).get();
    if (!snap.empty) return { id: snap.docs[0].id, data: snap.docs[0].data() };

    // 2) labNumber
    snap = await casesRef.where("labNumber", "==", trimmed).limit(1).get();
    if (!snap.empty) return { id: snap.docs[0].id, data: snap.docs[0].data() };

    // 3) barcode
    snap = await casesRef.where("barcode", "==", trimmed).limit(1).get();
    if (!snap.empty) return { id: snap.docs[0].id, data: snap.docs[0].data() };

    return null;
  }

  // ========= 1) CLINIC ENTRY FORM =========
  document.getElementById("clinicForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    try {
      const fileNumber = document.getElementById("fileNumber").value.trim();
      const patientName = document.getElementById("patientName").value.trim();
      const clinicNumber = document.getElementById("clinicNumber").value.trim();
      const doctorName = document.getElementById("doctorName").value.trim();
      const caseType = document.getElementById("caseType").value;
      const nextAppointment = document.getElementById("nextAppointment").value;
      const doctorNote = document.getElementById("doctorNote").value.trim();
      const requestImage = document.getElementById("requestImage").value.trim();

      if (!fileNumber || !patientName || !clinicNumber || !doctorName || !caseType) {
        showToast("âš ï¸ ØªØ£ÙƒØ¯ÙŠ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©.");
        return;
      }

      const labNumber = await getNextLabNumber();
      const barcode = labNumber; // Ù†ÙØ³ Ø§Ù„Ø±Ù‚Ù… Ù„Ù„Ø³Ù‡ÙˆÙ„Ø©
      const department = inferDepartment(caseType);

      const newCase = {
        fileNumber,
        patientName,
        clinicNumber,
        doctorName,
        caseType,
        department,
        nextAppointment: nextAppointment || null,
        doctorNote: doctorNote || "",
        requestImage: requestImage || "",
        createdAt: firebase.firestore.Timestamp.now(),
        status: "Entered from Clinic",
        labNumber,
        barcode,
        technicianName: "",
        boxNumber: "",
        isRejected: false,
        rejectionReason: ""
      };

      const docRef = await casesRef.add(newCase);
      await addTracking(docRef.id, "Entered from Clinic", "Clinic Reception", "Case added to system.");

      document.getElementById("clinicForm").reset();
      const lastCaseBox = document.getElementById("lastCaseBox");
      renderCaseSummary(lastCaseBox, docRef.id, newCase);
      updateQR(barcode);
      showToast("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØªÙˆÙ„ÙŠØ¯ Ø±Ù‚Ù… Ù…Ø¹Ù…Ù„.");

    } catch (err) {
      console.error(err);
      showToast("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©. ØªØ£ÙƒØ¯ÙŠ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.");
    }
  });

  // ========= 2) LAB CHECK-IN =========
  document.getElementById("btnLabSearch").addEventListener("click", async () => {
    const val = document.getElementById("labSearchInput").value;
    const box = document.getElementById("labSearchResult");
    box.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«â€¦";
    try {
      const result = await findCaseByAnyKey(val);
      if (!result) {
        box.textContent = "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.";
        return;
      }
      const { id, data } = result;
      const html = `
        <div><strong>${data.patientName}</strong> <span class="badge">Ù…Ù„Ù: ${data.fileNumber}</span> <span class="badge">Lab: ${data.labNumber}</span></div>
        <div class="muted">Ù†ÙˆØ¹: ${data.caseType} â€“ Ø¯.${data.doctorName} â€“ Ø¹ÙŠØ§Ø¯Ø© ${data.clinicNumber}</div>
        <div class="status-chip ${data.status === "In Lab" ? "in-lab" : ""}">
          Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${data.status}
        </div>
        <button class="btn btn-main" id="btnMarkInLab" style="margin-top:8px;">âœ… ØªØ£ÙƒÙŠØ¯ ÙˆØµÙˆÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù„Ù…Ø¹Ù…Ù„</button>
      `;
      box.innerHTML = html;

      document.getElementById("btnMarkInLab").onclick = async () => {
        try {
          await casesRef.doc(id).update({
            status: "In Lab"
          });
          await addTracking(id, "In Lab", "Lab Check-in", "Case received in lab.");
          showToast("âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ ÙˆØµÙˆÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù„Ù…Ø¹Ù…Ù„.");
          document.getElementById("labSearchResult").querySelector(".status-chip").textContent = "Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: In Lab";
          document.getElementById("labSearchResult").querySelector(".status-chip").classList.add("in-lab");
        } catch (e) {
          console.error(e);
          showToast("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«.");
        }
      };
    } catch (err) {
      console.error(err);
      box.textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø«.";
    }
  });

  // ========= TECHNICIANS LIST (for dashboard & settings) =========
  const defaultTechnicians = [
    // CAD/CAM
    { name: "Ù‚Ø§Ø³Ù… Ø¹Ø³ÙŠØ±ÙŠ", department: "CAD/CAM" },
    { name: "Ø£Ø­Ù…Ø¯ ÙƒÙˆØ´Ø§Ù†", department: "CAD/CAM" },
    { name: "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø´ÙŠØ¯", department: "CAD/CAM" },
    { name: "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø´Ù‡Ø±Ø§Ù†ÙŠ", department: "CAD/CAM" },
    { name: "Ø£Ø­Ù…Ø¯ Ø§Ù„Ù‚Ø­Ø·Ø§Ù†ÙŠ", department: "CAD/CAM" },
    { name: "ÙŠØ­ÙŠÙ‰ Ø¹Ø³ÙŠØ±ÙŠ", department: "CAD/CAM" },

    // PFM
    { name: "Ø³Ù„Ø·Ø§Ù† Ø§Ù„Ø§Ø­Ù…Ø±ÙŠ", department: "PFM" },
    { name: "Ø£ÙŠÙ…Ù† Ø§Ù„Ø´Ù‡Ø±ÙŠ", department: "PFM" },
    { name: "ÙÙŠØµÙ„ Ø§Ù„ÙˆØ§Ø¯Ø¹ÙŠ", department: "PFM" },

    // Ortho
    { name: "ØªØ±ÙƒÙŠ Ø§Ù„Ø´Ù‡Ø±ÙŠ", department: "Ortho" },
    { name: "ÙˆÙ„ÙŠØ¯ Ø§Ù„Ø´Ù‡Ø±ÙŠ", department: "Ortho" },
    { name: "Ø£Ø³Ø§Ù…Ø© Ø¹Ø³ÙŠØ±ÙŠ", department: "Ortho" },

    // RPD
    { name: "Ø±Ø´ÙŠØ¯ Ø§Ù„ÙƒØ«ÙŠØ±ÙŠ", department: "RPD" },
    { name: "Ø£Ø­Ù…Ø¯ Ø§Ù„ØµØ®Ø±ÙŠ", department: "RPD" },
    { name: "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ø·ÙŠÙ Ø¹Ø³ÙŠØ±ÙŠ", department: "RPD" },
    { name: "Ù…Ø­Ù…Ø¯ Ø§Ù„Ø´Ø±ÙØ§Ù†", department: "RPD" },
    { name: "Ø§Ù„Ø§Ø¡", department: "RPD" },
    { name: "Ù‡ÙŠØ§ Ù…", department: "RPD" },
    { name: "Ù…Ø­Ù…Ø¯ Ø§Ù„ØºØ§Ù…Ø¯ÙŠ", department: "RPD" },
    { name: "Ù…Ù†ØµÙˆØ± Ø§Ù„Ø¹ÙˆÙŠØ±Ø¶ÙŠ", department: "RPD" },
    { name: "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„ØºØ§Ù…Ø¯ÙŠ", department: "RPD" },

    // Temporary
    { name: "Ø§Ø­Ù…Ø¯ Ø§Ù„Ø´Ø¨Ù„", department: "Temporary" },
    { name: "ÙˆÙ„ÙŠØ¯ Ø§Ù„Ø³ÙˆÙŠØ±ÙŠ", department: "Temporary" },
    { name: "ÙÙ‡Ø¯ Ø§Ù„Ø¹ØªÙŠØ¨ÙŠ", department: "Temporary" },
    { name: "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø¹ÙˆØ¯", department: "Temporary" },

    // Casting
    { name: "ÙÙ‡Ø¯ Ø§Ù„Ø®Ù…ÙŠØ³", department: "Casting" }
  ];

  async function seedTechniciansIfEmpty() {
    const snap = await techsRef.limit(1).get();
    if (!snap.empty) {
      showToast("âœ… Ø§Ù„ÙÙ†ÙŠÙŠÙ† Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† Ù…Ø³Ø¨Ù‚Ø§Ù‹.");
      return;
    }
    const batch = db.batch();
    defaultTechnicians.forEach(t => {
      const doc = techsRef.doc();
      batch.set(doc, {
        name: t.name,
        department: t.department,
        active: true
      });
    });
    await batch.commit();
    showToast("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙ†ÙŠÙŠÙ†.");
    await loadTechSettingsList();
    await loadTechDropdown();
  }

  document.getElementById("btnSeedTechs").addEventListener("click", seedTechniciansIfEmpty);

  async function loadTechDropdown() {
    const select = document.getElementById("techNameFilter");
    const dept = document.getElementById("techDeptFilter").value;
    select.innerHTML = `<option value="">ÙƒÙ„ Ø§Ù„ÙÙ†ÙŠÙŠÙ†</option>`;

    let q = techsRef.orderBy("name");
    if (dept) q = q.where("department", "==", dept);
    const snap = await q.get();
    snap.forEach(doc => {
      const t = doc.data();
      if (!t.active) return; // ÙÙ‚Ø· Ø§Ù„Ù†Ø´Ø·ÙŠÙ† Ù„Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
      const opt = document.createElement("option");
      opt.value = doc.id;
      opt.textContent = `${t.name} (${t.department})`;
      select.appendChild(opt);
    });
  }

  document.getElementById("techDeptFilter").addEventListener("change", loadTechDropdown);

  // ========= SETTINGS â€“ TECH LIST =========
  async function loadTechSettingsList() {
    const list = document.getElementById("techSettingsList");
    const search = document.getElementById("techSearchInput").value.trim();
    let q = techsRef.orderBy("name");
    const snap = await q.get();
    if (snap.empty) {
      list.innerHTML = `<div class="case-item muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙ†ÙŠÙŠÙ† â€“ Ø§Ø¶ØºØ·ÙŠ Ø²Ø± Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙ†ÙŠÙŠÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©.</div>`;
      return;
    }
    list.innerHTML = "";
    snap.forEach(doc => {
      const t = doc.data();
      if (search && !t.name.includes(search)) return;
      const item = document.createElement("div");
      item.className = "case-item";
      item.innerHTML = `
        <div class="case-item-header">
          <div><strong>${t.name}</strong> <span class="badge">${t.department}</span></div>
          <div>
            <label style="font-size:10px;">
              <input type="checkbox" ${t.active ? "checked" : ""} data-id="${doc.id}" class="tech-active-toggle" />
              Ù†Ø´Ø· / Active
            </label>
          </div>
        </div>
      `;
      list.appendChild(item);
    });

    document.querySelectorAll(".tech-active-toggle").forEach(ch => {
      ch.addEventListener("change", async (e) => {
        const id = e.target.dataset.id;
        await techsRef.doc(id).update({ active: e.target.checked });
        showToast("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ÙÙ†ÙŠ.");
        loadTechDropdown();
      });
    });
  }

  document.getElementById("techSearchInput").addEventListener("input", () => {
    loadTechSettingsList();
  });

  // ========= SETTINGS â€“ PIN =========
  async function loadSettings() {
    const snap = await settingsRef.get();
    if (snap.exists && snap.data().specialistPin) {
      document.getElementById("specialistPinInput").value = snap.data().specialistPin;
    }
  }

  document.getElementById("btnSavePin").addEventListener("click", async () => {
    const pin = document.getElementById("specialistPinInput").value.trim();
    await settingsRef.set({ specialistPin: pin }, { merge: true });
    showToast("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ.");
  });

  // ========= TECH DASHBOARD â€“ LOAD CASES =========
  document.getElementById("btnLoadTechCases").addEventListener("click", async () => {
    const dept = document.getElementById("techDeptFilter").value;
    const techId = document.getElementById("techNameFilter").value;
    const list = document.getElementById("techCasesList");
    list.innerHTML = `<div class="case-item muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</div>`;

    let techName = "";
    if (techId) {
      const tSnap = await techsRef.doc(techId).get();
      if (tSnap.exists) techName = tSnap.data().name;
    }

    let q = casesRef.where("status", "!=", "Ready for Clinic"); // Firestore can't use "!=" + orderBy easily, ÙÙ†Ø¹Ù…Ù„ ÙÙ„ØªØ± ÙŠØ¯ÙˆÙŠ Ù„Ø§Ø­Ù‚Ø§Ù‹
    if (dept) q = q.where("department", "==", dept);
    if (techName) q = q.where("technicianName", "==", techName);

    const snap = await q.orderBy("createdAt", "desc").limit(40).get().catch(async (err) => {
      // Ø¥Ø°Ø§ Ø£Ø¹Ø·Ù‰ Ø®Ø·Ø£ Ø¨Ø³Ø¨Ø¨ (!=) Ù†Ø³ØªØ®Ø¯Ù… ÙÙ„ØªØ± ÙŠØ¯ÙˆÙŠ
      console.warn("fallback query", err);
      let q2 = casesRef;
      if (dept) q2 = q2.where("department", "==", dept);
      const s2 = await q2.orderBy("createdAt", "desc").limit(40).get();
      return s2;
    });

    if (snap.empty) {
      list.innerHTML = `<div class="case-item muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ÙÙ†ÙŠ/Ø§Ù„Ù‚Ø³Ù….</div>`;
      return;
    }

    list.innerHTML = "";
    snap.forEach(doc => {
      const data = doc.data();
      if (data.status === "Ready for Clinic") return;
      if (techName && data.technicianName !== techName) return;

      const item = document.createElement("div");
      item.className = "case-item";
      item.innerHTML = `
        <div class="case-item-header">
          <div>
            <strong>${data.patientName}</strong>
            <span class="badge">Ù…Ù„Ù: ${data.fileNumber}</span>
            <span class="badge">Lab: ${data.labNumber}</span>
          </div>
          <div class="muted">${data.caseType || ""}</div>
        </div>
        <div class="muted">Ø¯.${data.doctorName || "-"} â€“ Ø¹ÙŠØ§Ø¯Ø© ${data.clinicNumber || "-"}</div>
        <div class="muted">Ø§Ù„ÙÙ†ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${data.technicianName || "Ù„Ù… ÙŠØ­Ø¯Ø¯ Ø¨Ø¹Ø¯"}</div>
        <div class="status-chip ${data.status === "Completed" ? "complete" : ""}">
          Ø§Ù„Ø­Ø§Ù„Ø©: ${data.status || "-"}
        </div>
        <div class="case-item-actions">
          <button class="btn btn-ghost btn-assign" data-id="${doc.id}">ğŸ“Œ ØªØ¹ÙŠÙŠÙ† ÙÙ†ÙŠ</button>
          <button class="btn btn-main btn-progress" data-id="${doc.id}">â–¶ï¸ In Progress</button>
          <button class="btn btn-main btn-complete" data-id="${doc.id}">âœ… Completed</button>
          <button class="btn btn-danger btn-return" data-id="${doc.id}">â†©ï¸ Returned</button>
        </div>
      `;
      list.appendChild(item);
    });

    // Events
    list.querySelectorAll(".btn-assign").forEach(btn => {
      btn.addEventListener("click", async (e) => {
        const id = e.target.dataset.id;
        const techIdSel = document.getElementById("techNameFilter").value;
        if (!techIdSel) {
          showToast("Ø§Ø®ØªØ§Ø±ÙŠ ÙÙ†ÙŠ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø£ÙˆÙ„Ø§Ù‹.");
          return;
        }
        const tSnap = await techsRef.doc(techIdSel).get();
        if (!tSnap.exists) return;
        const name = tSnap.data().name;
        await casesRef.doc(id).update({ technicianName: name, department: tSnap.data().department });
        await addTracking(id, "Assigned to Technician", name, "Case assigned to technician.");
        showToast("âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ†ÙŠ Ù„Ù„Ø­Ø§Ù„Ø©.");
        document.getElementById("btnLoadTechCases").click();
      });
    });

    list.querySelectorAll(".btn-progress").forEach(btn => {
      btn.addEventListener("click", async (e) => {
        const id = e.target.dataset.id;
        await casesRef.doc(id).update({ status: "In Progress" });
        await addTracking(id, "In Progress", "Technician", "Work started.");
        showToast("â–¶ï¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¢Ù† In Progress.");
        document.getElementById("btnLoadTechCases").click();
      });
    });

    list.querySelectorAll(".btn-complete").forEach(btn => {
      btn.addEventListener("click", async (e) => {
        const id = e.target.dataset.id;
        await casesRef.doc(id).update({ status: "Completed" });
        await addTracking(id, "Completed", "Technician", "Work finished.");
        showToast("âœ… Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¢Ù† Completed.");
        document.getElementById("btnLoadTechCases").click();
      });
    });

    list.querySelectorAll(".btn-return").forEach(btn => {
      btn.addEventListener("click", async (e) => {
        const id = e.target.dataset.id;
        const reason = prompt("Ø³Ø¨Ø¨ Ø±Ø¬ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„Ø©ØŸ (Returned Reason)");
        await casesRef.doc(id).update({ status: "Returned", isRejected: true, rejectionReason: reason || "" });
        await addTracking(id, "Returned", "Technician", reason || "Returned without note.");
        showToast("â†©ï¸ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© ÙƒÙ€ Returned.");
        document.getElementById("btnLoadTechCases").click();
      });
    });
  });

  // ========= READY FOR CLINIC =========
  document.getElementById("btnReadySearch").addEventListener("click", async () => {
    const val = document.getElementById("readySearchInput").value;
    const box = document.getElementById("readySearchResult");
    box.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«â€¦";
    try {
      const res = await findCaseByAnyKey(val);
      if (!res) {
        box.textContent = "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø©.";
        return;
      }
      const { id, data } = res;
      const html = `
        <div><strong>${data.patientName}</strong> <span class="badge">Ù…Ù„Ù: ${data.fileNumber}</span> <span class="badge">Lab: ${data.labNumber}</span></div>
        <div class="muted">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${data.status}</div>
        <label style="margin-top:6px;">Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Box Number</label>
        <input type="text" id="readyBoxInput" value="${data.boxNumber || ""}" />
        <button class="btn btn-main" id="btnMarkReady" style="margin-top:8px;">âœ… Ready for Clinic</button>
      `;
      box.innerHTML = html;
      document.getElementById("btnMarkReady").onclick = async () => {
        const boxNumber = document.getElementById("readyBoxInput").value.trim();
        await casesRef.doc(id).update({ status: "Ready for Clinic", boxNumber });
        await addTracking(id, "Ready for Clinic", "Specialist", "Case delivered to clinic / box " + boxNumber);
        showToast("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ready for Clinic.");
      };
    } catch (e) {
      console.error(e);
      box.textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø«.";
    }
  });

  document.getElementById("btnLoadCompleted").addEventListener("click", async () => {
    const list = document.getElementById("readyCasesList");
    list.innerHTML = `<div class="case-item muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</div>`;
    const snap = await casesRef.where("status", "==", "Completed").orderBy("createdAt", "desc").limit(20).get();
    if (snap.empty) {
      list.innerHTML = `<div class="case-item muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª Ù…ÙƒØªÙ…Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</div>`;
      return;
    }
    list.innerHTML = "";
    snap.forEach(doc => {
      const d = doc.data();
      const item = document.createElement("div");
      item.className = "case-item";
      item.innerHTML = `
        <div class="case-item-header">
          <div>
            <strong>${d.patientName}</strong>
            <span class="badge">Lab: ${d.labNumber}</span>
          </div>
          <div class="muted">${d.caseType}</div>
        </div>
        <div class="muted">Ù…Ù„Ù: ${d.fileNumber} â€“ Ø¯.${d.doctorName}</div>
        <button class="btn btn-main btn-ready-small" data-id="${doc.id}">âœ… Ready for Clinic</button>
      `;
      list.appendChild(item);
    });

    list.querySelectorAll(".btn-ready-small").forEach(btn => {
      btn.addEventListener("click", async (e) => {
        const id = e.target.dataset.id;
        const boxNum = prompt("Box Number / Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ØŸ");
        await casesRef.doc(id).update({ status: "Ready for Clinic", boxNumber: boxNum || "" });
        await addTracking(id, "Ready for Clinic", "Specialist", "Case delivered to clinic / box " + (boxNum || ""));
        showToast("âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«.");
        document.getElementById("btnLoadCompleted").click();
      });
    });
  });

  // ========= GLOBAL SEARCH =========
  document.getElementById("btnGlobalSearch").addEventListener("click", async () => {
    const val = document.getElementById("globalSearchInput").value;
    const box = document.getElementById("globalCaseDetails");
    const trackBox = document.getElementById("globalTracking");
    box.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«â€¦";
    trackBox.textContent = "";
    try {
      const res = await findCaseByAnyKey(val);
      if (!res) {
        box.textContent = "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø©.";
        trackBox.textContent = "â€”";
        return;
      }
      const { id, data } = res;
      renderCaseSummary(box, id, data);

      const tSnap = await casesRef.doc(id).collection("tracking").orderBy("time", "asc").get();
      if (tSnap.empty) {
        trackBox.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØªØ¨Ø¹ Ø¨Ø¹Ø¯.";
        return;
      }
      let html = "";
      tSnap.forEach(doc => {
        const t = doc.data();
        const date = t.time.toDate();
        const formatted = date.toLocaleString("en-GB");
        html += `
          <div class="muted">
            <strong>${t.status}</strong> â€“ Ø¨ÙˆØ§Ø³Ø·Ø© ${t.updatedBy || "-"}<br/>
            <span style="font-size:9px;">${formatted}</span><br/>
            <span style="font-size:10px;">${t.note || ""}</span>
          </div>
          <hr style="border:0;border-top:1px dashed #eee;margin:6px 0;">
        `;
      });
      trackBox.innerHTML = html;
    } catch (e) {
      console.error(e);
      box.textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø«.";
      trackBox.textContent = "â€”";
    }
  });

  // ========= INITIAL LOAD =========
  (async function init() {
    try {
      await loadSettings();
      await loadTechSettingsList();
      await loadTechDropdown();
      showToast("âœ¨ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² â€“ DSA LAB SYSTEM");
    } catch (e) {
      console.error(e);
    }
  })();
</script>
</body>
</html>
